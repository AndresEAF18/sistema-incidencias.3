<!DOCTYPE html>  
<html lang="es">  
<head>  
    <meta charset="UTF-8">  
    <title>Registrar Incidente</title>  
    <link rel="stylesheet" href="/incidencias/assets/css/registrar_incidente.css">  
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />  
    <style>  
        #map { height: 300px; width: 100%; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; }  
    </style>  
</head>  
<body>  
  
<form action="../Controllers/registrar_incidente_procesar.php"  
      method="POST"  
      enctype="multipart/form-data">  
  
    <h2>Registrar Incidente</h2>  
  
    <label>Título del incidente:</label><br>  
    <input type="text" name="titulo" placeholder="Ej: Luminaria fundida" required><br><br>  
  
    <label>Descripción:</label><br>  
    <textarea name="descripcion" required rows="4" placeholder="Describa el problema detalladamente..."></textarea><br><br>  
  
    <label>Ubicación (Haga clic en el mapa):</label>  
    <input type="text" id="ubicacion" name="ubicacion" readonly required placeholder="Latitud, Longitud">  
    <div id="map"></div>  
  
    <label>Categoría:</label><br>  
    <select name="categoria" id="categoria" required>  
        <option value="">Seleccione una categoría</option>  
        {{optionsCategorias}}  
    </select><br>  
    <br>  
  
    <label>Subcategoría:</label><br>  
    <select name="subcategoria" id="subcategoria" required>  
        <option value="">Seleccione una subcategoría</option>  
    </select><br>  
      
    <br>   
    <input type="submit" value="Registrar Incidente">  
    <br>  
      
    <br>  
    <a href="panel_usuario.php" style="display:block; text-align:center; color:#666;">Cancelar y volver</a>  
</form>  
  
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>  
  
<script>  
/* ======================  
   CONFIGURACIÓN DEL MAPA  
====================== */  
var map = L.map('map').setView([-0.180653, -78.467838], 13);  
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {  
    attribution: '© OpenStreetMap contributors'  
}).addTo(map);  
  
var marker;  
  
// Intentar obtener ubicación actual del usuario  
if (navigator.geolocation) {  
    navigator.geolocation.getCurrentPosition(function(position) {  
        var lat = position.coords.latitude;  
        var lng = position.coords.longitude;  
  
        map.setView([lat, lng], 15);  
        marker = L.marker([lat, lng], {draggable:true}).addTo(map);  
        document.getElementById('ubicacion').value = lat + ',' + lng;  
  
        marker.on('dragend', function() {  
            var pos = marker.getLatLng();  
            document.getElementById('ubicacion').value = pos.lat + ',' + pos.lng;  
        });  
    });  
}  
  
map.on('click', function(e) {  
    if (marker) {  
        marker.setLatLng(e.latlng);  
    } else {  
        marker = L.marker(e.latlng, {draggable:true}).addTo(map);  
    }  
    document.getElementById('ubicacion').value = e.latlng.lat + ',' + e.latlng.lng;  
});  
  
/* ======================  
   CARGA DINÁMICA DE SUBCATEGORÍAS  
====================== */  
document.getElementById('categoria').addEventListener('change', function () {  
    const idCategoria = this.value;  
    const subSelect = document.getElementById('subcategoria');  
  
    subSelect.innerHTML = '<option value="">Cargando...</option>';  
  
    if (idCategoria === '') {  
        subSelect.innerHTML = '<option value="">Seleccione una subcategoría</option>';  
        return;  
    }  
  
    fetch('../Controllers/obtener_subcategorias.php?idCategoria=' + idCategoria)  
        .then(response => response.json())  
        .then(data => {  
            subSelect.innerHTML = '<option value="">Seleccione una subcategoría</option>';  
            data.forEach(sub => {  
                subSelect.innerHTML += `<option value="${sub.idSubcategoria}">${sub.nombre}</option>`;  
            });  
        })  
        .catch(error => {  
            console.error('Error:', error);  
            subSelect.innerHTML = '<option value="">Error al cargar</option>';  
        });  
});  
</script>  
  
</body>  
</html>